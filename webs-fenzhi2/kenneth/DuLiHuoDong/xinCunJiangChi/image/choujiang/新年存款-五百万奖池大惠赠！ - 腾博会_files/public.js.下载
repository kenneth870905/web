/**
* Util: 放置一些全局实用函数
*/
var Util = {
    // 4位以内的补零
    pad0:function (s, len) {
        return ('0000' + s).slice(-len || -2)
    },
    join: function () {
        var str = '';
        if (arguments&&arguments.length) {
            for (var a = 0; a < arguments.length; a++) {
                str += arguments[a];
            }
        }
        return str;
    },
    ajaxLink: function (apiName, apiData) {
        var data = {};
        data[apiName] = apiData || {};
        var win = window.open();
      $.invoke_api(data, {
        success: function (data) {
            // console.log(data);
            if (data.Status == 1) {
                var row = data.row;
                if (typeof row === 'string' && row.substr(0,4) === 'http') {
                    // window.open(row);
                    win.location.href = row;
                } else if (row.Url) {
                    // window.open(row.Url);
                    win.location.href = row.Url;
                }
            }
            else {
                win.close();
            }
        },
        error: function () {
            win.close();
        }
      });
    },
    GamePlat: (function () {
        return {
            '': { id: '', title: '主账户', abbr:'', imgPath: '' },
            9:{ id: '9', title: 'BBIN波音厅', abbr: 'BBIN', imgPath: 'bbing' },
            11:{ id: '11', title: 'AG旗舰厅', abbr: 'AG', imgPath: 'agg' },
            12:{ id: '12', title: 'AG国际厅' , abbr: 'AG', imgPath: 'agg'},
            15: { id: '15', title: 'PT厅', abbr: 'PT', imgPath: 'ptg' },
            16:{ id: '16', title: 'MG厅', abbr: 'MG', imgPath: 'mgg' },
            //17:{ id: '17', title: 'MG国际厅', abbr: 'MG', imgPath: 'mgg' },
            18:{ id: '18', title: 'TTG厅', abbr: 'TTG', imgPath: 'ttgg' },
            20:{ id: '20', title: 'GG厅', abbr: 'GG', imgPath: 'ggg' },
            21:{ id: '21', title: 'DT厅', abbr: 'DT', imgPath: 'dtgg' },
            22:{ id: '22', title: 'SW厅', abbr: 'SW', imgPath: 'swg' },
            23:{ id: '23', title: 'PP厅', abbr: 'PP', imgPath: 'ppg' },
            24:{ id: '24', title: 'PS厅', abbr: 'PS', imgPath: 'psg' },
            25:{ id: '25', title: '平博厅', abbr: '平博', imgPath: '' },
            26:{ id: '26', title: 'PT国际厅', abbr: 'PTIN', abbrCN: 'PT国际', imgPath: 'ptg' },
            27:{ id: '27', title: 'AE厅', abbr: 'AE', imgPath: 'aeg' },
            28:{ id: '28', title: '开元棋牌厅', abbr: '开元', imgPath: '' },
            //29:{ id: '29', title: 'VR厅', abbr: 'VR', imgPath: '' },
            30:{ id: '30', title: 'CQ9厅', abbr: 'CQ9', imgPath: 'cq9g' },
            31:{ id: '31', title: 'PNG厅', abbr: 'PNG', imgPath: 'pngg' },
            32: { id: '32', title: '761棋牌厅', abbr: 'QP761', imgPath: '' },
            33: { id: '33', title: 'IM厅', abbr: 'IM', imgPath: '' },
            34: { id: '34', title: 'NT厅', abbr: 'NT', imgPath: 'ntg' },
            35: { id: '35', title: 'PT亚洲厅', abbr: 'PTA', abbrCN: 'PT亚洲', imgPath: 'ptg' },
            36: { id: '36', title: '三国棋牌厅', abbr: '三国', imgPath: '' },
            37: { id: '37', title: 'MG亚洲厅', abbr: 'MGA', abbrCN: 'MG亚洲', imgPath: 'mgag' },
            38: { id: '38', title: 'QG刮刮乐厅', abbr: 'QG', abbrCN: 'QG厅', imgPath: 'qgg' },
            39: { id: '39', title: '大富翁棋牌厅', abbr: 'RMG', abbrCN: 'RMG厅', imgPath: 'rmg' },
            40: { id: '40', title: 'AB娱乐厅', abbr: 'ALLBET', abbrCN: 'ALLBET厅', imgPath: 'allbetg' }
        }
    })()
};
$.fn.Dialog = function (options) {
    var $that = $(this);
    var _obj = {
        type: "Ok",
        title: "温馨提示",
        messageTitle:"",
        message: "",
        autoClose: false,   // 是否自动关闭弹出框
        autoCloseTime: 5,   // autoClose为True时，多少秒后自动关闭
        isShade: true,       // 是否遮罩
        buttons: [
            //{         // 排列顺序从左到右
            //    name: "确定",
            //    callback: function () { alert("默认1"); }
            //}
        ],
        closeHandler: function () {
            $(".pro-box").remove();
            $(".pro-big-box").remove();
            $(".popup-overlay").remove();
        }
    };

    options = $.extend(_obj, options);

    if ($("#login_conponent").length) return;
    $.fn.SetTemplate($that, options);
}

$.fn.SetTemplate = function (_that, options) {
    $(".pro-box").remove();
    $(".pro-big-box").remove();
    $(".popup-overlay").remove();

    var _dialogContains = $('<div class="' + ((options.message.length > 25 && options.big !== false) ? "pro-big-box" : "pro-box") + '">');
    var _dialogHead = $('<div class="pro-box-bt">');
    var _dialogBody = $('<div class="pro-box-con">');
    var _dialogFoot = $('<div class="pro-box-an fr">');
    var _dialogShade = $('<div class="popup-overlay">');

    // 设置标题
    var _title = $('<h2 class="pro-box-bt-title"></h2>');
    var _close = $('<div class="pro-box-bt-off bg-ico fr">');
    _title.text(options.title);
    _dialogHead.append(_title).append(_close);
    _close.bind("click", wrapCallback(options.closeHandler));

    // 设置内容
    var _bodyImg = $('<div class="pro-box-con-img"><img src="' + imgRootPath + 'image/pic/bg/U-Prot-' + options.type + '.png"></div>');
    var _bodyContent = $('<div class="pro-box-con-msg">');
    var _bodyMessageTitle = $('<h2>' + options.messageTitle + '</h2>');
    var _bodyMessage = $('<p>' + options.message + '</p>');

    // 添加内容
    if (options.messageTitle) {
        _bodyContent.append(_bodyMessageTitle)
    }

    if (options.message) {
        _bodyContent.append(_bodyMessage);
    }

    _dialogBody.append(_bodyImg).append(_bodyContent);

    if (options.autoClose) {
        var _countDown = $('<div class="zero-count">');
        var _countBold = $('<b>');
        var _count = options.autoCloseTime;
        _countBold.text(_count);
        _countDown.append(_countBold).append('秒后自动关闭该窗口');
        _dialogBody.append(_countDown);
        _count-=1;
        var autoClose = setInterval(function () {
            _countBold.text(_count);
            if (_count === 0) {
                options.closeHandler();
                window.clearInterval(autoClose);
                autoClose = null;
            }
            _count--;
        }, 1000);
    }

    function wrapCallback(cb) {
        return function () {
            if (autoClose) {
                window.clearInterval(autoClose);
                autoClose = null;
            }
                cb();
        }
    }
    // 设置操作
    if (options.buttons && options.buttons.length) {
        $.each(options.buttons, function (b, opt) {
            // html 标签一定要闭合，不然老IE有bug
            var _btn = $('<a class="pro-box-button-default" href="javascript:void(0);">' + opt.name +'</a>');
            _btn.bind("click", wrapCallback(opt.callback));
            if (opt._class) _btn.addClass(opt._class);
            _dialogFoot.append(_btn);
        })
    }
    // if (!!options.buttons.forEach) {
    //     options.buttons.forEach(function (opt, i) {
    //         // html 标签一定要闭合，不然老IE有bug
    //         var _btn = $('<a class="pro-box-button-default" href="javascript:void(0);"></a>');
    //         _btn.text(opt.name);
    //         _btn.bind("click", wrapCallback(opt.callback));
    //         if (opt._class) _btn.addClass(opt._class);
    //         _dialogFoot.append(_btn);
    //     });
    // }
    // else {
    //     var n = options.buttons.length;
    //     for (var i = 0; i < n; i++) {
    //         var opt = options.buttons[i];
    //         var _btn = $('<a class="pro-box-button-default" href="javascript:void(0);"></a>');
    //         _btn.text(opt.name);
    //         _btn.bind("click", wrapCallback(opt.callback));
    //         _dialogFoot.append(_btn);
    //     }
    // }



    if (options.isShade) {
        $("body").append(_dialogShade);
    }

    _dialogContains.append(_dialogHead);
    _dialogContains.append(_dialogBody);

    if (options.buttons.length != 0) {
        _dialogContains.append(_dialogFoot);
    }

    _that.append(_dialogContains);
};

/*
    添加收藏动画效果
    1.新增div层，用于克隆存放游戏整个模块层
    2.新层div移动到指定坐标点（这个移动过程中容器大小慢慢变小）
    3.新层div移除，坐标点div添加动画效果
*/

function move(options) {
    var _opt = {
        beginTarget: "", // 起点元素所在父容器，也就是需要移动的容器
        endTarget: ""   // 结束点元素
    };

    options = $.extend(_opt, options);

    if (!options.beginTarget || !options.endTarget) {
        console.log("beginTarget/endTarget is empty");
        return;
    }

    var beginPoint = $(options.beginTarget).offset();
    var endPoint = $(options.endTarget).offset();

    var floatContains = $('<div class="float-contains">');
    $(options.beginTarget).clone().appendTo(floatContains);

    floatContains.css({
        'left': beginPoint.left,
        'top': beginPoint.top,
        'position': "absolute",
        'z-index': 10,
        'border-radius': 12 + "px"
    });

    $('body').append(floatContains);

    floatContains.animate({ top: endPoint.top - 15, left: endPoint.left + 3, width: 15, height: 15, opacity: .4 }, 800, function () {
        $(options.endTarget).css({ 'transform': "scale(1.1)", '-webkit-transform': "scale(1.1)", '-ms-transform': "scale(1.1)" });
    })
    .animate({ top: endPoint.top + 12, left: endPoint.left + 10, width: 0, height: 0, opacity: 0 }, 1500, function () {
        $(options.endTarget).css({ 'transform': "scale(1)", '-webkit-transform': "scale(1)", '-ms-transform': "scale(1)" });
        floatContains.remove();
    })

};


function loadPage(options) {
    var _opt = {
        data: [],           // 数据集合
        dataType: 0,         // 数据类型 0：表示data中将存放所有数据，前端自行实现分页; 1：表示data中存入的是部分分页数据，后端已处理分页（这里只需要实现呈现动画）
        pageIndex: 0,       // 当前页码 这里的当前页不能涉及强行指定；后面的数据加载都是基于该值进行累加
        pageSize: 24,       // 当前显示数量
        contains: "",       // 父容器
        imagePath: "",
        imageType: "",
        isSearch: false
    }

    options = $.extend(_opt, options);

    return {
        setImageType: function (imgType) {
            options.imageType = imgType;
            return this;
        },
        setData: function (insertData) {
            options.data = insertData;
            return this;
        },
        clearData: function () {
            options.pageIndex = 0;
            options.data = [];
            return this;
        },
        insertData: function (insertData) {
            options.data.push(insertData);
            return this;
        },
        setIsSearch: function(isSearch){
            options.isSearch = isSearch;
        },
        nextPage: paging
    };

    // 分页
    function paging() {
        var currentIndex = ++options.pageIndex;
        var pageContains = $(options.contains); //$('<div id="page_Contains_' + currentIndex + '" class="pageContains" >');
        var liTemplate = '<li class="fl {6}" id="fl_egame_{3}"><div><img  id="egame_{3}" src="' + options.imagePath + 'image/pic/bg/egame-loading.gif"  data-original="{2}?v={8}"><dl><dt></dt><dd class="ntb-egame-psp">{5}</dd></dl></div><h3 class="ov-h"><a href="javascript:void(0)" gamecode="{0}" gamename="{1}" data-html5="{7}" onclick="playGame($(this))" title="{1}">{1}</a></h3><span class="fr bg-ico egame-sc {4}" title="收藏此游戏" data-id="{3}" onClick="changeFavorite(this)"></span></li>';
        var liTemplate1 = '<li class="fl {6}"  id="fl_egame_{3}"><span class="fl bg-ico egame-sc {4}" id="egame_{3}" data-id="{3}" onClick="changeFavorite(this)" title="收藏此游戏"></span><h3 class="fl"><a href="javascript:void(0)" gamecode="{0}" onclick="playGame($(this));" title="{1}">{1}</a></h3><span class="gameList-list-item"><a class="fr eg-list-02-a" href="javascript:void(0)" gamecode="{0}" gamename="{1}" data-html5="{7}" onclick="playGame($(this));">开始游戏</a><a class="fr eg-list-02-a2"  href="javascript:void(0)" gamecode="{0}" data-html5="{7}" onclick="try_playGame($(this));">试玩体验</a></span></li>';
        var searchTemp = '<li class="fl"><div><img  id="egame_{3}" src="' + window.__STATIC__ + 'image/pic/bg/egame-loading.gif" data-original="{2}?v={8}"><dl><dt></dt><dd class="ntb-egame-psp"><a class="game-link-1" gamecode="{0}" data-html5="{5}" rel="{7}" onclick="playGame($(this));">开始游戏</a><a href="javascript:;" class="game-link-2" gamecode="{0}" gamename="{1}" data-html5="{5}" rel="{7}" onclick="try_playGame($(this));">试玩体验</a></dd></dl></div><h3 class="ov-h"><a href="javascript:void(0);" gamecode="{0}" rel="{7}" data-html5="{5}" onclick="playGame($(this));" title="{1}">{1}</a></h3><span class="fr bg-ico egame-sc {4}" title="收藏此游戏" data-id="{3}" onClick="changeFavorite(this)"></span><p class="platName">{6}厅</p></li>';
        var searchTemp2 = '<li class="fl" id="fl_egame_{3}"><span class="fl bg-ico egame-sc {4}" id="egame_{3}" data-id="{3}" onClick="changeFavorite(this)" title="收藏此游戏"></span><h3 class="fl" style="margin-top:-7px;"><a href="javascript:void(0)" gamecode="{0}" data-html5="{5}" onclick="playGame($(this));">{1}</a><h4 class="platName2">{6}厅</h4></h3><span class="gameList-list-item"><a class="fr eg-list-02-a" href="javascript:void(0)" gamecode="{0}" gamename="{1}" data-html5="{5}"  rel="{7}" onclick="playGame($(this));">开始游戏</a><a class="fr eg-list-02-a2"  gamecode="{0}" gamename="{1}" data-html5="{5}" onclick="try_playGame($(this));" rel="{7}">试玩体验</a></span></li>';
        var liData = [];

        if (options.dataType === 0) {
            //如果是移动设备
            if (isMobile())
                options.pageSize = 42;
            // 自行分页
            var maxIndex = Math.ceil(options.data.length * 1.0 / options.pageSize);
            if (currentIndex <= maxIndex) {
                for (var i = (currentIndex - 1) * options.pageSize; i < currentIndex * options.pageSize; i++) {
                    var data = options.data[i];
                    if (!!data) {
                        var objLi;
                        var html5 = (data.Html5 == 1);
                        var Gimage, PlatName;
                        var plat = Util.GamePlat[data.GType];
                        if ($('#egli-tab').find('.on').attr('data-index') == 0) {
                            if (options.isSearch) {
                                Gimage = plat && plat.imgPath;
                                PlatName = plat && (plat.abbrCN || plat.abbr);
                                //PlatName = PlatName == 'PTIN' ? 'PT国际' : PlatName;
                                objLi = $(searchTemp.format(data.Code, data.CNName, data.PCImgUrl, data.ID, "", html5, PlatName, data.GType, data.ModifyTime));
                                 //if (plat && plat.id == "37")
                                 //    objLi.find('div>img').after('<img src="' + options.imagePath + 'image/bg/icon_dbtb.png" class="icon_dbtb"/>')
                            }
                            else {
                                objLi = $(liTemplate.format(data.Code, data.CNName, data.PCImgUrl, data.ID, "", (data.Maintain == "0" ? '<a class="game-link-1" gamecode="' + data.Code + '" data-html5="' + html5 + '" onclick="playGame($(this));" >开始游戏</a><a class="game-link-2"  gamecode="' + data.Code + '" data-html5="' + html5 + '" onclick="try_playGame($(this));" >试玩体验</a>' : '<a class="game-link-1">游戏维护</a>'), (data.Maintain == "0" ? "" : "game-unavailable"), html5, data.ModifyTime));
                                 //if (plat && plat.id == "37")
                                 //    objLi.find('div>img').after('<img src="' + options.imagePath + 'image/bg/icon_dbtb.png" class="icon_dbtb"/>')
                            }

                            objLi.css({
                                'position': "relative",
                                'bottom': -50 + "px",
                                'margin': '20px 10px 15px 31px',
                                'opacity': 0
                            });

                            // if ($(".egame-type li.on").attr('rel') == '17' && data.Code == 'MegaMoolah') {
                            //     objLi.append('<i class="icon-mg-dajiang">大奖</i>');
                            // }
                        } else {
                            if (options.isSearch){
                                Gimage = plat && plat.imgPath;
                                PlatName = plat && (plat.abbrCN || plat.abbr);
                                objLi = $(searchTemp2.format(data.Code, data.CNName, Gimage, data.ID, "", html5, PlatName, data.GType));
                            }
                            else
                                objLi = $(liTemplate1.format(data.Code, data.CNName, "", data.ID, "", (data.Maintain == "0" ? '<a class="game-link-1" gamecode="' +data.Code + '" data-html5="{1}" onclick="playGame($(this));" >开始游戏</a>' : '<a class="game-link-1 bg-ico">游戏维护</a>'), (data.Maintain == "0" ? "" : "game-unavailable"), html5));
                        }
                        liData.push(objLi);
                        pageContains.append(objLi);
                    }
                }
            }
            else {
                return;
            }
        }
        else if (options.dataType === 1) {
            // 动态分页
        }
        else {
            //console.log("传入的dataType类型值不正确");
            return;
        }
        if ($('#egli-tab').find('.on').attr('data-index') == 0) {
            imgLazyload(); // 第三方
        }

        animateShow(liData);
    }

    // 动画
    function animateShow(liData) {
        var animateCount = setInterval(function () {
            if (liData.length === 0) {
                clearInterval(animateCount);
            }
            else {
                var data = liData.shift();
                callBackTimeOut(data);
            }
        }, 50);
    }

    function callBackTimeOut(obj) {
        obj.animate({
            "bottom": 0,
            "opacity": 1
        }, {
            queue: false,
            duration: 200
        });
    }
}

// 插入GeeTest
function insertGeet(data, container, width, succCallback) {
    initGeetest({
        // 以下 4 个配置参数为必须，不能缺少
        gt: data.row.gt,
        challenge: data.row.challenge,
        offline: data.row.success == 0 ? true : false, // 表示用户后台检测极验服务器是否宕机
        new_captcha: data.row.new_captcha, // 用于宕机时表示是新验证码的宕机


        product: "float", // 产品形式，包括：float，popup
        width: width || "100%",
        https: true
        // 更多配置参数说明请参见：http://docs.geetest.com/install/client/web-front/
    }, function (captchaObj) {
        $(container).empty();
        captchaObj.appendTo($(container)[0]);
        captchaObj.onReady(function () {
            window.__CAPTCHA_OBJECT__ = captchaObj;
        });

        //验证成功后的回调
        captchaObj.onSuccess(function () {
            console.log('ok');
            if (succCallback && typeof succCallback == 'function') {
                succCallback();
            }
        });

    });
}

/**
 * bind，隐藏按钮式； 对于bind类型，需要注意此时appendTo接口调用将无效，验证时调用verify实例方法进行验证。
 * @param {any} data
 * @param {any} container
 * @param {any} width
 * @param {any} succCallback
 */
function insertGeetBind(data, container, width, succCallback) {
    initGeetest({
        // 以下 4 个配置参数为必须，不能缺少
        gt: data.row.gt,
        challenge: data.row.challenge,
        offline: data.row.success == 0 ? true : false, // 表示用户后台检测极验服务器是否宕机
        new_captcha: data.row.new_captcha, // 用于宕机时表示是新验证码的宕机


        product: "bind", 
        width: width || "100%",
        https: true
        // 更多配置参数说明请参见：http://docs.geetest.com/install/client/web-front/
    }, function (captchaObj) {
        captchaObj.onReady(function () {
            window.__CAPTCHA_OBJECT__ = captchaObj;            
            if ($('.login-anniu .login-anniu-div').size()>0)
                $('.login-anniu .login-anniu-div').removeClass('btn-disabled');
        });

        //验证成功后的回调
        captchaObj.onSuccess(function () {
            console.log('ok');
            if (succCallback && typeof succCallback == 'function') {
                succCallback();
            }
        });

        $(container).click(function () {            
            captchaObj.verify();           
        })

    });
}

/*
    登录
    1.分两种情况 a:操作超时 b:未登录
    2.以单例模式调用
    //登录异常标识KEY: tengbo.login.error VALUE:true
*/

function tbLogin() {
    var _opt = {
        loginType: 0,// 1:表示登录过，但已超时，需要重新登录 0:表示未登录过
        loginMsgs: ["您尚未登录或已超时，请登录！", ""],
        loginCustomMsg: "",// 需要另外提示信息
        loginUrl: "",//  登录提交地址
        forgetUrl: "",// 忘记密码
        registerUrl:"", //注册
        apiUrl:"",   // api接口地址
        verifyImageSrc:"", // 验证码图片地址
        verifyImageFunction: function (obj) { },// 验证码刷新
        nav_index:0,
        callBack: function (obj) { },
        closeBack: function (obj) { }
    };

    if (!!loginConponent) {
        return loginConponent;
    }

    return {
        infinite: 5,
        loginContainsObj: "",
        ResetInfinite:function(){
            this.infinite = 5;
        },
        SubtractInfinite: function () {
            if (this.infinite < 0) return;
            this.infinite--;
        },
        SetOption: function (option) {
            _opt = $.extend(_opt, option);
            return this;
        },
        //显示验证码表单
        ShowVerifyCode: function () {            
            var verifyDom = $('<div class="login-inpt code-input" style="position: relative;display:none;">');
            verifyCode(function (data) {               
                if (data.row && data.row.CodeVersion == 2) {                                  
                    insertGeetBind(data, '.login-anniu-div', '', function () {
                        setTimeout(function () {
                            //btnLogin_click();
                            $('.login-anniu-div-hide').trigger('click');
                        }, 300);
                    });
                }
                else {
                        console.log('data:image/png;base64,' + data.row.imgdata);
                        var verInnerHtml = '<input id="ipt_code" style="width:41%;float:left;" name="n3" placeholder="验证码" type="text">' +
                        '<img id="login_CheckCode" class="login_CheckCode fl" src="data:image/png;base64,' + data.row.imgdata + '" width="80" height="44" title="点击刷新"><span class="pop-login-span-err"></span>';
                        verifyDom.html(verInnerHtml).show();
                        if ($("#login_conponent .popup-content .login-anniu").size() > 0 && $("#ipt_code").size() < 1) {
                            $("#login_conponent .popup-content .login-anniu").prepend(verifyDom);
                            $("#login_CheckCode").bind("click", _opt.verifyImageFunction);
                            setTimeout(function () {
                                tipInputClose("login");
                                $(".btn-input-close").eq(0).show();
                                $(".btn-input-close").eq(1).show();
                            }, 20);
                        }
                }
            });
        },
        InitLogin: function (tempOption) {
            //$("#login_conponent").remove();
            this.CookieDie();

            var loginContains = $('<div id="login_conponent" class="popup pop-login">');
            var overlay = $('<div class="popup-overlay">');
            var content = $('<div class="popup-content">');
            var closeIcon = $('<div class="popup-off bg-ico">');
            closeIcon.bind("click", _opt.closeBack);

            var loginForm = $('<div class="adapt login-con">');

            var title = $('<div><h2 class="login-bt"><b class="cur_login">用户名登录</b><b>手机登录</b></h2><span class="pop-login-err ' + (!!tempOption && !!tempOption.loginType ? "d_n" : "") + '">' + (!!tempOption && !!tempOption.loginType ? _opt.loginMsgs[tempOption.loginType] : _opt.loginMsgs[_opt.loginType]) + '</span></div>');

            var userNameLogin = $('<div id="userNameLogin">');
            var phoneLogin = $('<div id="phoneLogin" style="display:none;">');

            var loginNameDiv = $('<div class="login-inpt login-input">');
            var loginNameSpan = $('<span class="pop-login-span-err"></span>');
            var loginNameInput = $('<input id="account" name="n1" type="text" placeholder="请输入用户名" />');

            var phoneNameDiv = $('<p style="color:#999;margin:10px 0;text-align:center;">支持手机注册及已通过手机认证的账户登录</p><div class="login-inpt login-input"><span class="pop-login-span-err"></span><input id="phone" name="phone" type="text" style="width:60%" placeholder="请输入手机号" /><button class="getCode" id="getCodeBtn" type="button" disabled>发送验证码</button>');
            var phonePwdDiv = $('<div class="login-inpt pwd-input"><span class="pop-login-span-err"></span><input id="phone_password" name="phone_password" type="text" placeholder="请输入短信验证码"/>');
            phoneLogin.append(phoneNameDiv).append(phonePwdDiv);

            var loginPwdDiv = $('<div class="login-inpt pwd-input">');
            var loginPwdSpan = $('<span class="pop-login-span-err"></span>');
            var loginPwdInput = $('<input id="login_password" name="n2" type="password" placeholder="请输入密码"/>');

            var loginVerifyDiv = $('<div class="login-inpt code-input" style="display:none;">');
            var loginVerifySpan = $('<span class="pop-login-span-err"></span>');

            var loginVerifyInput = $('<input id="ipt_code" style="width:41%;float:left;" name="n3" placeholder="验证码" type="text"/>');

            var verifyImg = $('<img id="login_CheckCode" class="login_CheckCode fl" src="" width="80" height="44" title="点击刷新"/>');
            verifyImg.bind("click", _opt.verifyImageFunction);

            var btnDivLogin = $('<div class="login-anniu">');
            var btnlogin = $('<input  class="login-anniu-div btn-disabled" type="button" value="登&nbsp;&nbsp;录" data-type="userNameLogin"/>');
            var btnloginHide = $('<input class="login-anniu-div-hide" type="hidden" value="&nbsp;&nbsp;"/>'); //为了保持登录逻辑代码不变，增加个暗部按钮

            btnDivLogin.append(btnlogin);
            btnDivLogin.append(btnloginHide);

            if (!!tempOption && !!tempOption.callBack) {
                // 临时调用时配置
                btnlogin.bind("click", tempOption.callBack);
                btnloginHide.bind("click", tempOption.callBack);

                loginVerifyInput.bind("keydown", tempOption.callBack);
                loginNameInput.bind("keydown", tempOption.callBack);
                loginPwdInput.bind("keydown", tempOption.callBack);
            }
            else {
                btnlogin.bind("click", _opt.callBack);
                btnloginHide.bind("click", _opt.callBack);

                loginVerifyInput.bind("keydown", _opt.callBack);
                loginNameInput.bind("keydown", _opt.callBack);
                loginPwdInput.bind("keydown", _opt.callBack);
            }



            loginNameDiv.append(loginNameInput).append(loginNameSpan);
            loginPwdDiv.append(loginPwdInput).append(loginPwdSpan);
            userNameLogin.append(loginNameDiv).append(loginPwdDiv);

            //第一次登录异常
            // if ($.cookie("tengbo.login.error")) {
                loginForm.append(title).append(userNameLogin).append(phoneLogin).append(loginVerifyDiv).append(btnDivLogin);
            verifyCode(function (data) {                
                if (data.row && data.row.CodeVersion == 2) {                       
                    insertGeetBind(data, '.login-anniu-div', '', function () {                        
                        setTimeout(function () {
                            $('.login-anniu-div-hide').trigger('click');
                        }, 300);
                    });
                }
                else {
                    $('.code-input').show();
                    loginVerifyDiv.append(loginVerifyInput).append(verifyImg).append(loginVerifySpan);
                    $("#login_CheckCode").attr('src', 'data:image/png;base64,' + data.row.imgdata).css({'margin':'8px 0 0 15px'});
                }
                });
            // } else {//正常不显示验证码
            //     loginForm.append(title).append(userNameLogin).append(phoneLogin).append(btnDivLogin);
            // }

            //切换登录方式
            title.find('h2.login-bt b').click(function(){
                var index = $(this).index(),
                    tempDom = userNameLogin;
                $(this).addClass('cur_login').siblings().removeClass('cur_login');
                $("#userNameLogin").show();
                $("#phoneLogin").hide();
                $("input.login-anniu-div").attr('data-type', 'userNameLogin');
                $(".pop-login-err").hide();
                //if($(".code-input").size()>0)
                //        $(".code-input").show();
                if(index==1){
                    $("#userNameLogin").hide();
                    $("#phoneLogin").show();
                    $("input.login-anniu-div").attr('data-type', 'phoneLogin');
                    if($(".code-input").size()>0)
                        $(".code-input").hide();
                }
                setTimeout(function () {
                    tipInputClose("login");
                }, 10);
            })


            //输入手机号事件
            var last_phone_keyup_time , msg_timer=null;
            phoneNameDiv.find('#phone').keyup(function (e) {
                last_phone_keyup_time = e.timeStamp;
                var $this = $(this);
                setTimeout(function(){
                    if(last_phone_keyup_time-e.timeStamp===0){
                        var reg = /^1[3456789][0-9]{9}$/,
                            data_val = $this.val().trim();
                        if(reg.test(data_val)){
                            clearInterval(msg_timer);
                            $this.parent().find('#getCodeBtn').prop('disabled', false);
                        }else{
                            $this.parent().find('#getCodeBtn').prop('disabled', true);
                        }
                    }
                },80)
                $(this).next('i').off().click(function(){
                    $this.val('').focus();
                    $this.parent().find('#getCodeBtn').prop('disabled', true);

                })
            })
            phoneNameDiv.find('#getCodeBtn').on('click', getPhoneCode);
            /**
             * 获取验证码
             * @return {[type]} [description]
             */
            function getPhoneCode(){
                var phone = $(this).parent().find('#phone').val(),
                $this = $(this);
                // console.log(phone);
                $(this).text('发送中...').prop('disabled', true);
                getMobileCode(phone,1,function(data){
                    console.log(data);
                    //data = {Status:301, RepMsg:'该手机号未认证'};
                    if(data.Status==964){
                        $('.pop-login-err').hide().text('');
                        var time = 60;
                        clearInterval(msg_timer);
                        msg_timer = setInterval(function(){
                            if(time<=0){
                                clearInterval(msg_timer);
                                $this.text('发送验证码').prop('disabled', false);
                            }else{
                                $this.text('( '+time+' s) 重新发送').prop('disabled', true);
                            }
                            time--;
                        },1000);

                    }else{
                        if(data.Status==976 || data.Status==8003){
                            $this.text('发送验证码').prop('disabled', false);
                        }else{
                            $this.text('发送验证码').prop('disabled', true);
                        }
                        $('.pop-login-err').text(data.RepMsg).css({'display':'inline'});
                    }
                });
            }

            if (!_opt.isPT) {
                var otherForget = $('<div class="adapt login-link"><span class="fl"><a href="' + _opt.forgetUrl + '">忘记密码</a></span><p class="fr">还没有账号？<a href="' + _opt.registerUrl + '">点击注册</a></p></div>');
                loginForm.append(otherForget);
            }

            loginContains.append(overlay).append(content);
            content.append(closeIcon).append(loginForm);

            this.loginContainsObj = loginContains;
            // this.ShowVerifyCode();
        },
        Show: function (tempOption) {
            if (!!$("#login_conponent").length) {
                return;
            }
            this.InitLogin(tempOption);
            $('body').append(this.loginContainsObj);
            $('#account').focus();
            setTimeout(function () {
                tipInputClose("login");
            }, 100);
            if ($("div.u-load-div").size() > 0) {
                $("div.u-load-div").hide();
            }
        },
        Hide: function () {
            this.loginContainsObj.remove();
        },
        IsLogin: function () {
            var memberToken = $.cookie("memberToken");
            if (!!memberToken) {
                return true;
            }
            else {
                return false;
            }
        },
        ShowState: function (targetState, targetOperate) {
            if ($.cookie("memberToken")) {
                var that = this;
                $.invoke_api({ UserBalance: {} }, {
                    success: function (data, textStatus, jqXHR) {
                        switch (data.Status) {
                            case 16:
                            case -6:
                                that.CookieDie();
                                break;
                        }
                        follow();
                    }
                });
            }
            else {
                follow();
            }
            function follow() {
                $("#login_member_top_component").remove();
                $("#login_member_opreate_component").remove();

                var memberToken = $.cookie("memberToken");
                var memberName = "***";
                var memberBalance = "***";
                // var signed = CheckInState.get();

                if (!!memberToken) {
                    memberName = $.cookie("memberHideACNT");
                    memberBalance = $.cookie("memberBalance");
                    $("#nav_forgotPwd").remove();
                }
                else {
                    // 用户未登录

                    if (location.pathname.indexOf("MemberCenter") != -1 && !$("#login_conponent").length) {
                        location.href = "/";
                        return;
                    }


                    var memberStateHtml = '<div class="login_member_status fl">'
                                       + '<a class="title-phone fl" href="/mobile.aspx"><span></span>APP</a>'
                                       + '<a class="title-pc-client fl" href="/tbapp.aspx#tbh_2"><span></span>电脑版</a>'
                                       + '<span class="fl title-fenge">|</span>'
                                        + '<a class="title-help fl" href="/Help/default.aspx#5"><span></span>新手帮助</a>'
                                        + '<span class="fl title-fenge">|</span>'
                                        //+ '<a class="title-cunkuan fl"><span></span>存款演示</a>'
                                        + '<span class="fl title-fenge">|</span>'
                                        + '<a class="title-pawd fl" href="' + _opt.forgetUrl + '"><span></span>忘记密码</a>'
                                        //+ '<p class="fl title-hello">您好，请先登录</p>'
                                        + '<span class="fl btn-login" onclick="loginConponent.Show({loginType:1})">用户登录</span>'
                                        + '<a href="' + _opt.registerUrl + '" class="fl btn-reg">免费开户</a>'
                                        + '</div> ';

                    //$(targetState).prepend(memberStateHtml);
                    $(targetState).append(memberStateHtml);

                    var operateHtml = '<div class="tb-login fr login_panel">'
                                    + '<div class="tb-login-q">'
                                    + '<a class="bg-ico btn-login fl" style="cursor:pointer;" onclick="loginConponent.Show({loginType:1})">登  录</a>'
                                    + '<a class="bg-ico btn-reg fl" href="' + _opt.registerUrl + '">免费开户</a>'
                                    + '</div>  '
                                    + '</div>';

                    $(targetOperate).html(operateHtml);
                    //显示试玩
                    $("#tb-tryplay").show();

                    //单个游戏试玩体验
                    if ($(".ntb-zxdy li div.ntb-dyan-ys").size() > 0)
                        $(".ntb-zxdy li div.ntb-dyan-ys").removeClass("one-an");
                    if ($("ul#gameList-ul").size() > 0)
                        $("ul#gameList-ul").removeClass("one-an");

                    //最近玩
                    $("#lastestGame-hide").parent().hide();
                    $("#showLastGames").hide();

                    //vip回拨
                    $(".tb-vipzxhb").hide();
                    return;
                }
                var selfService = function () {
                    return '<a href="javascript:void(0)" onclick="gotoZzyh(24)">自助洗码</a>'
                                    + '<a href="javascript:void(0)" onclick="gotoZzyh(25)">信息认证</a>'
                                    //+ '<a href="javascript:void(0)" onclick="gotoZzyh(30)">周勤好礼</a>'
                                    + '<a href="javascript:void(0)" onclick="gotoZzyh(32)">幸运注单</a>'
                                    //+ '<a href="javascript:void(0)" onclick="gotoZzyh(33)">周年礼金</a>'
                                    //+ '<a href="javascript:void(0)" onclick="gotoZzyh(36)">电游礼金</a>'
                                    + '<a href="javascript:void(0)" onclick="gotoZzyh(37)">月救援金</a>'
                                    + '<a href="javascript:void(0)" onclick="gotoZzyh(38)">好友推荐</a>'
                                    + '<a href="javascript:void(0)" onclick="gotoZzyh(39)">棋牌奖金</a>'
                                    + '<a href="javascript:void(0)" onclick="gotoZzyh(40)">棋牌救援</a>'
                                    + '<a href="javascript:void(0)" onclick="gotoZzyh(42)">棋牌众乐</a>'
                                    + '<a href="javascript:void(0)" onclick="gotoZzyh(47)">千倍百倍</a>'
                                    + '<a href="javascript:void(0)" onclick="gotoZzyh(48)">首存红利</a>'
                                    //+ '<a href="javascript:void(0)" onclick="gotoZzyh(41)">VR奖金</a>';
                }
                // 顶部状态
                var memberStateHtml = '<div id="login_member_top_component" class="ntb-login-ok" style="min-width:530px">'
                                    + '<a class="title-phone fl" href="/mobile.aspx"><span></span>APP</a>'
                                    + '<a class="title-pc-client fl" href="/tbapp.aspx#tbh_2"><span></span>电脑版</a>'
                                    + '<span class="fl title-fenge">|</span>'
                                    + '<div class="fl" style="display: block;">'
                                    + '<div class="fl">您好，<span><a href="/MemberCenter/Default.aspx">' + memberName + '</a></span></div>'
                                    + '<div class="member-balance fl">余额：<span class=" banlance_span_1" onclick="toggleBalance()" title="点击显隐金额">' + memberBalance + '</span>&nbsp;&nbsp;<span onclick="refreshBalance();" class="bg-ico-refresh-default refresh_balance"></span></div>'
                                    + '<em class="fl">|</em>'
                                    + '<div class="fl ntb-login-umenu">'
                                   // + '<a class="login-member-menu fl" href="/MemberCenter/Deposit.aspx">存款</a><em class="fl">|</em>'
                                   // + '<a class="login-member-menu fl" href="/MemberCenter/Withdrawal.aspx">提款</a><em class="fl">|</em>'
                                   // + '<a class="login-member-menu fl" href="/MemberCenter/GameTran.aspx">转账</a><em class="fl">|</em>'
                                    + '<a class="login-member-menu fl login-xiala-a2" href="/MemberCenter/Deposit.aspx" data-n="1">资金<b class="bg-ico"></b></a><em class="fl">|</em>'
                                    + '<p class="ntb-u-zijinP" style="display:none;" data-n="3">'
                                    + '<span>▲</span>'
                                    + '<a href="/MemberCenter/Deposit.aspx">会员存款</a>'
                                    + '<a href="/MemberCenter/Withdrawal.aspx">会员提款</a>'
                                    + '<a href="/MemberCenter/GameTran.aspx">户内转账</a>'
                                    + '<a href="/Help/default.aspx#8">存款演示</a>'
                                    + '</p>'
                                    + '<a class="login-member-menu fl login-xiala-a" href="/MemberCenter/PromotionXM.aspx" data-n="1">自助<b class="bg-ico"></b></a><em class="fl">|</em>'
                                    + '<p class="login-yh-xl" style="display:none;" data-n="1">'
                                    + '<span>▲</span>'
                                    + selfService()
                                    + '</p>'
                                    + '<a class="login-member-menu fl" href="javascript:void(0)" onclick="gotoZzyh(31)" style="min-width:45px;padding:0;">站内信<b class="user-newsNo">0</b></a>'
                                    + '</div>'
                                    + '<button class="btn_checkin">签到</button>'
                                    + '<span class="pointer " onclick="btnLogout_click()">退出</span>'
                                    + '</div></div>';

                $(targetState).html("");
                $(targetState).prepend(memberStateHtml);
                $("#login_member_top_component .user-newsNo").hide();
                if (!!$.cookie('tengbo.com.msgnum') && $(".user-newsNo").size() > 0) {
                    var num = $.cookie('tengbo.com.msgnum') > 0 ? $.cookie('tengbo.com.msgnum') : 0;
                    if(num>0)
                        $("#login_member_top_component .user-newsNo").text(num).show();
                    else
                        $("#login_member_top_component .user-newsNo").hide();
                }
                //显示试玩
                $("#tb-tryplay").hide();
                //游戏列表
                if ($("ul#gameList-ul").size() > 0)
                    $("ul#gameList-ul").addClass("one-an");
                if ($(".ntb-zxdy li div.ntb-dyan-ys").size() > 0)
                    $(".ntb-zxdy li div.ntb-dyan-ys").addClass("one-an");
                // 顶部操作
                if (!!targetOperate) {
                    var operateHtml = '<div id="login_member_opreate_component">'
                                        +'<dl class="tb-l-yhxx">'
                                            +'<dd class="fl">'
                                                +'<div class="fl">'
                                                + '<a class="login-member-menu fl" href="/MemberCenter/Deposit.aspx">存款</a><em class="fl">|</em>'
                                                + '<a class="login-member-menu fl" href="/MemberCenter/Withdrawal.aspx">提款</a><em class="fl">|</em>'
                                                + '<a class="login-member-menu fl" href="/MemberCenter/GameTran.aspx">转账</a><em class="fl">|</em>'
                                                + '<a class="login-member-menu fl login-xiala-a" data-n="2" href="/MemberCenter/PromotionXM.aspx">自助<b class="bg-ico"></b></a>'
                                            + '</div>'
                                            +'</dd>'
                                        + '</dl>'
                                        + '<p class="login-yh-xl" data-n="2">'
                                            + '<span>▲</span>'
                                            + selfService()
                                        + '</p>'
                                     + '</div>';
                    $(targetOperate).html(operateHtml);
                    $(".login-xiala-a, .login-yh-xl").hover(
                        function () {
                            var index = $(this).attr("data-n") - 1;
                            $(".login-yh-xl").eq(index).show();
                        },
                        function () {
                            var index = $(this).attr("data-n") - 1;
                            $(".login-yh-xl").eq(index).hide();
                    });
                    $(".login-xiala-a2, .ntb-u-zijinP").hover(
                        function () {
                            $(".ntb-u-zijinP").show();
                        },
                        function () {
                            $(".ntb-u-zijinP").hide();
                        });

                    //最近玩
                    if ($.cookie('showLastGames')) {
                        $("#lastestGame-hide").parent().show();
                        $("#showLastGames").hide();

                    } else {
                        $("#lastestGame-hide").parent().hide();
                        $("#showLastGames").show();
                    }
                }
                CheckInState.check();
                // 签到功能，全局监听
                $(document).off('click.checkin').on('click.checkin', '.btn_checkin', function () {

                    var $this = $(this);
                    if ($this.hasClass('signed')) {
                        $.invoke_api(
                                     {GetTengBiMallSignInRecordList: {}},
                                    {
                                        success: function (res) {
                                            console.log(res);
                                            if (res.Status === 1) {
                                                var row = res.row;
                                                var total = 0;
                                                $.each(row, function (i, r) {
                                                    total += r.TengBiAmount;
                                                });
                                                $('body').Dialog({ type: "Ok", title: "签到记录",
                                                         messageTitle: '共获得腾币 ' + total + ' !',
                                                         big:false, message: '本月累计签到 ' + row.length + ' 天，连续签到 ' + row[row.length - 1].Days + ' 天',
                                                         autoClose: true,
                                                         // autoCloseTime: 333,
                                                         buttons: [{
                                                            name: "确定",
                                                            callback: function () { closeDialog(0);}
                                                        }],
                                                         closeHandler: function () { closeDialog(0); } });
                                            }

                                        }
                                    }
                        )
                    }
                    else {
                        var map = {
                            11001:1,
                            11002:1
                        }
                        $.invoke_api({TengBiMallSignIn:{}}, {
                            success: function (res) {
                                if (res.Status === 1) {
                                    var row = res.row;
                                    $('.btn_checkin').text('已签到').addClass('signed');
                                    $('#tengbi_balance').text(row.TengBiBalance.toLocaleString('en'));
                                    CheckInState.set(true, res.serverTime);
                                    $('body').Dialog({ type: "Ok", title: "签到成功",
                                                     messageTitle: '获得腾币 ' + row.Amount + ' !',
                                                     big:false, message: '已连续签到 ' + row.Days + ' 天',
                                                     autoClose: true,
                                                         buttons: [{
                                                            name: "确定",
                                                            callback: function () { closeDialog(0);}
                                                        }],
                                                     closeHandler: function () { closeDialog(0); } });
                                }
                                else {
                                    $('body').Dialog({ type: "Ask", title: "温馨提示",
                                                     big:false, message: map[res.Status] ? res.Message : getMsg(res.Status),
                                                     autoClose: true,
                                                     buttons: [{
                                                        name: "立即充值",
                                                        callback: function () { location.href = '/MemberCenter/Deposit.aspx'}
                                                    }],
                                                     closeHandler: function () { closeDialog(0); } });
                                }
                            }
                        })
                    }
                })
            }



        },
        ShowError: function (errorType,data) {
            $('#login_CheckCode').click();
            if (errorType == 7) {
                // 验证码错误
                $(".pop-login-err").show().html("验证码错误");
                $("#ipt_code").focus().blur(function () {
                    $('#ipt_code').parent().removeClass("err");
                }).parent(".login-inpt").addClass("err");
            }
            else if (errorType == 12) {
                // 密码错误
                if (data.args[1] > 0) {
                    $(".pop-login-err").show().html('密码错误,还剩<span style="color:#06f;margin:0 3px;">' + data.args[1] + '</span>次输入机会！');
                } else {
                    console.log(data.args[1]);
                    $(".pop-login-err").show().html('密码错误超过5次,锁定24小时,通过<a href="/ResetPassword.aspx" style="color:#09f;">找回密码</a>或手机登录解锁！');
                }
                $('#login_password').focus().blur(function () {
                    $('#login_password').parent().removeClass("err");
                }).parent().addClass("err");
                //后期添加
                // $('#login_CheckCode').click();
            }
            else if (errorType == 8 || errorType == 11) {
                // 账号不存在
                $(".pop-login-err").show().html("账号不存在");
                $('#account').focus().blur(function () {
                    $('#account').parent().removeClass("err");
                }).parent().addClass("err");
                //后期添加
                // $('#login_CheckCode').click();
            }
            else {
                $(".pop-login-err").show().html(getMsg(errorType) || "登录发生错误，请稍后再试！");
            }
        },
        CookieLive: function (memberToken, memberName,memberHideName, memberBalance, memberGroupID, memberSID) {

            //var expiresDate = new Date();
            //var hour = 0.5;
            //expiresDate.setTime(expiresDate.getTime() + (hour * 60 * 60 * 1000));
            // expires: expiresDate,
            $.cookie("memberToken", memberToken, { path: '/' });
            $.cookie("memberACNT", memberName, { path: '/' });
            $.cookie("memberHideACNT", memberHideName, { path: '/' });
            $.cookie("memberBalance", memberBalance, {  path: '/' });
            $.cookie("memberGroupID", memberGroupID, { path: '/' });
            $.cookie("SID", memberSID, { path: '/' });

        },
        CookieDie: function () {
            $.removeCookie("memberToken", { path: '/' });
            $.removeCookie("memberHideACNT", { path: '/' });
            $.removeCookie("memberBalance", { path: '/' });
            $.removeCookie("memberACNT", { path: '/' });
            $.removeCookie("memberGroupID", { path: '/' });
            // 其它
            $.removeCookie("banlance_span", { path: '/' });

            $.removeCookie("ptlogin", { path: '/' });
            $.removeCookie("ptpwd", { path: '/' });
            $.removeCookie("ptinlogin", { path: '/' });
            $.removeCookie("ptalogin", { path: '/' });
            $.removeCookie("SID", { path: '/' });

            //mg柜台用户名
            $.removeCookie("mglogin", { path: '/' });

        }
    }

}

function readNotice(obj) {
    var $that = $(obj);

    var noticeContains = $('<div class="popup pop-TbNews">');
    var shade = $('<div class="popup-overlay">');
    var box = $('<div class="popup-content">');
    var boxTitle = $('<div class="pop-TbNews-bt"><h2 class="fl">公告详情</h2><div class="popup-off fr bg-ico" onclick="closeReadNotice()"></div></div>');

    var divNoticeContent = $('<div id="m-wrapper" class="optiscroll fl">');
    $.each($that.find(".Tb-News-span"), function (s, i) {
        var t = $(i).attr("data-title");
        var time = $(i).attr("data-time");
        var content = $(i).text();
        var html = '<dl class="adapt u-news-dl"><dt class="adapt"><span class="fl">' + t + '</span></dt><dd>' + content + '</dd></dl>';
        divNoticeContent.append(html);
    });

    box.append(boxTitle).append(divNoticeContent);
    noticeContains.append(shade).append(box);
    $('body').append(noticeContains);
}

function closeReadNotice() {
    $('.pop-TbNews').remove();
    $('.popup-overlay').remove();
}

/*
    调查评价
*/
function research(option) {
    var _opt = {
        callBack: function (obj) { },
        closeBack: function (obj) { }
    };

    _opt = $.extend(_opt, option);

    return {
        questContainsObj:"",
        Initquest: function () {
            // 问卷调查弹窗
            $('.quest-text').remove();
            var questText = $('<div class="quest-text">');
            var questTextBg = '<div class="quest-text-bg"></div>';
            var questConter = $('<div class="quest-conter">');

            var questConterBt = $('<div class="quest-conter-bt"></div>');
            var title = '<span class="fl">体验报告</span>';
            var questClose = $('<span class="fr bg-ico quest-conter-off"></span>');
            questConterBt.append(title).append(questClose);
            questClose.bind('click', _opt.closeBack);

            var conter = '<h3>选择满意度</h3>                                                                             '+
                         '   <div class="quest-input adapt">                                                              '+
                         '       <label><input type="radio" name="n1" value="1" />&nbsp;很不满意</label>                  '+
                         '       <label><input type="radio" name="n1" value="2" />&nbsp;不满意</label>                    '+
                         '       <label><input type="radio" name="n1" value="3" />&nbsp;一般</label>                      '+
                         '       <label><input type="radio" name="n1" value="4" />&nbsp;满意</label>                      '+
                         '       <label><input type="radio" name="n1" value="5" checked="checked" />&nbsp;非常满意</label>'+
                         '   </div>                                                                                       '+
                         '<h3>个人建议</h3>';
           var questTextarea = $('<textarea name="n2" style="resize: none;" cols="" rows="" onkeydown="checkMaxInput(this,400)"  onkeyup="checkMaxInput(this,400)" >');
           var questMax = '<div id="max_quest" style="text-align: right;color: red;font-weight: bold;margin: 5px 20px -10px 0;"></div>';
           var questConterBtn =$('<div class="fl quest-conter-but">');
           var questBtn = $('<div class="bfc" id="questBtn">提交建议</div>');
           questBtn.bind("click", _opt.callBack);

           questConterBtn.append(questBtn);
           questConter.append(questConterBt).append(conter).append(questTextarea).append(questMax).append(questConterBtn);
           questText.append(questTextBg).append(questConter);
           $('#research').append(questText);
           questText.fadeIn(300).addClass("on")
           this.questContainsObj = questText;
        },
        Show: function () {
            this.Initquest();
        },
        Hide: function () {
            this.questContainsObj.remove();
        }
    }

}


function ClientInfo() {
    return {
        Terminal: GetTerminal(),
        BSCore: GetBSCore(),
        OSVer: GetOSVer(),
        Host: location.hostname,
        IP: ""
    };
}

function GetOSVer() {
    var userAgent = navigator.userAgent;
    var result = "";

    if (userAgent.indexOf("NT 10.0") != -1) result = "Windows 10";
    else if (userAgent.indexOf("NT 6.3") != -1) result = "Windows 8.1";
    else if (userAgent.indexOf("NT 6.2") != -1) result = "Windows 8";
    else if (userAgent.indexOf("NT 6.1") != -1) result = "Windows 7";
    else if (userAgent.indexOf("NT 6.0") != -1) result = "Windows Vista/Server 2008";
    else if (userAgent.indexOf("NT 5.2") != -1 && userAgent.indexOf("64") != -1) result = "Windows XP";
    else if (userAgent.indexOf("NT 5.2") != -1 && userAgent.indexOf("64") == -1) result = "Windows Server 2003";
    else if (userAgent.indexOf("NT 5.1") != -1) result = "Windows XP";
    else if (userAgent.indexOf("NT 5") != -1) result = "Windows 2000";
    else if (userAgent.indexOf("NT 4") != -1) result = "Windows NT4";
    else if (userAgent.indexOf("Me") != -1 && userAgent.indexOf("Windows") != -1)     /**/ result = "Windows Me";
    else if (userAgent.indexOf("98") != -1 && userAgent.indexOf("Windows") != -1)     /**/ result = "Windows 98";
    else if (userAgent.indexOf("95") != -1 && userAgent.indexOf("Windows") != -1)     /**/ result = "Windows 95";
    else if (userAgent.indexOf("Mac") != -1)    /**/ result = "Mac";
    else if (userAgent.indexOf("Unix") != -1)   /**/ result = "Unix";
    else if (userAgent.indexOf("Linux") != -1)  /**/ result = "Linux";
    else if (userAgent.indexOf("SunOS") != -1)  /**/ result = "SunOS";
    else result = userAgent.platform;

    return result;
}

function GetBSCore() {
    var userAgent = navigator.userAgent;
    var result = "";

    ///MSIE[\s]+[\d]*[\.][\d]+/.exec(text); // 10-7
    ///Chrome\/[\d]*[\.][\d]*/.exec(text);
    ///Safari\/[\d]*[\.][\d]*/.exec(text);
    ///Firefox\/[\d]*[\.][\d]*/.exec(text);


    if (userAgent.indexOf("Firefox") != -1) {
        result = /Firefox\/[\d]*[\.][\d]*/.exec(userAgent);
    }
    else if (userAgent.indexOf("Chrome") != -1) {
        result = /Chrome\/[\d]*[\.][\d]*/.exec(userAgent);
    }
    else if (userAgent.indexOf("Trident") != -1 && userAgent.indexOf("MSIE") != -1) { // 6-10
        result = /MSIE[\s]+[\d]*[\.][\d]+/.exec(userAgent);
        //result = result.replace("MSIE", "IE");
    }
    else if (userAgent.indexOf("Trident") != -1 && userAgent.indexOf("Gecko") != -1) {
        result = "IE 11";
    }else if (userAgent.indexOf("Safari") != -1) { //苹果safari浏览器
        result = "Safari";
    }
    return result.toString();
}

function GetTerminal() {
    var userAgent = navigator.userAgent;
    var result = "PC";
    var terminals = ["Android", "iPhone", "iPod", "iPad", "Windows Phone", "MQQBrowser"];
    for (var i = 0; i < terminals.length; i++) {
        if (userAgent.toLowerCase().indexOf(terminals[i].toLowerCase()) != -1) {
            return terminals[i];
        }
    }
    return result;
}



/**
 * 登录超时的操作
 */
function loginTimeout(){
    this.data = {};
    //this.apiData = ""; //重新登录后需要执行的API
    //this.url = ""; //重新登录后需要跳转
    return this;
};

loginTimeout.prototype.setLoginTimeoutData = function(opt){
    var _opt = {
        apiData:"", //API名字
        url: "", //要跳转的链接
        mIndex: 0
    };
    _opt = $.extend(_opt,opt);
    $.cookie("loginTimeoutData",JSON.stringify(_opt));
}

/**
 * 登录超时前的动作及内容保存的数据，存放在cookie里
 * @return {[type]} [description]
 */
loginTimeout.prototype.getCookieData = function(){
    var tempData = $.cookie("loginTimeoutData")
    if(tempData!=null){
        this.data = JSON.parse(tempData);
    }
}


/**
 * 重新登录后执行之前的 Api
 * @return {[type]} [description]
 */
loginTimeout.prototype.doBeforeTimeout = function(){
    var _this = this;
    this.getCookieData();
    if (this.data == null) return false;
    this.callBack();
    /*
    $.invoke_api(this.data.apiData, {
        async: false,
        success: function () {
            _this.callBack();
        }
    });
  */
    return true;
}


loginTimeout.prototype.callBack = function () {
    var command = this.data.apiData;
    for (var key in command) {
        this.callBackByKey(key);
    }
    $.removeCookie("loginTimeoutData");
}


loginTimeout.prototype.callBackByKey = function (key) {
    var that = this;
    var index = this.data.mIndex;
    var flag = false; //不做处理开关
    var donothingApi = ['GetUnfinishOrder', 'GetUnfinishOrder', '']; //不做处理的api
    for (var i = 0; i < donothingApi.length; i++) {
        if (donothingApi[i] == key) {
            flag = true;
        }
    }
    if (flag) { //不需要做任何处理的
        console.log(key);
    }
    // 如果是在游戏窗口，则刷新
    else if (~location.href.indexOf('gameloading.aspx')) {
        return location.reload();
    }
    else if (key == "RequestBankDepositCommand") { // 存款-绿色通道
        if ($("#btnPay").size() > 0)
            $("#btnPay").click();
    } else if (key == "RequestAstroPay" || key == "AlipayBankDepositCommand" || key == "CheckCashChannelLimit") { //存款- AstroPay || 存款-支付宝转银行卡
        if ($("#btnPay").size() > 0)
            $("#btnPay").click();
    } else if (key == "UserGameTran") { //户内转账
        var gameid_1 = this.data.apiData[key].gameid_0 ? 1 : 2;
        if (gameid_1 == 1)
            $("#gamewithdrawal input.btn-3").click();
        else
            $("#gamewithdrawal input.btn-2").click();
    } else if (key == "UserGameBalance") {  //财务中心-基本信息
        this.doSomeofGame(key, function (index) {
            $("ul.n-u-quota li").eq(index).find("span.bg-ico").click();
            index = null;//变量来自闭包，手动释放资源
        })
    } else if (key == "UserBalance") { //获取总余额
        refreshBalance();
    } else if (key == "SleVerification") { //修改银行信息
        bankAccountModif();
    } else if (key == "MailAgreement") {  //验证邮箱
        $("div.sendBtn_mail_first").click();
    } else if (key == "TelAgreement") {  //手机邮箱
        $("div.sendBtn_phone_first").click();
    } else if (key == "UpdateMemberBankCommand") {  //银行卡验证
        $("#form02_1 .btn-3").click();
    } else if (key == "SetSafeQuestionCommand") {  //安全问题设置
        $("#form05_1 .btn-3").click();
    } else if (key == "UpdateLoginPwdCommand") {  //登录密码修改
        $("#form04_1 .btn-3").click();
    } else if (key == "UpdateSafePasswordCommand") {  //安全密码设置
        $("#form05_2 .btn-3").click();
    } else if (key == "retBindTel") {  //安全密码重置
        $("#form05_2 .btn-2").click();
    } else if (key == "RequestWithdrawalCommand") {  //会员提款-财务中心
        $(".btn-3").click();
    } else if (key == "SelfServiceEntry") {  //自助入账--支付宝转银行卡
        $(".btn-3").eq(0).click();
    } else if (key == "SelfServiceEntry") {  //自助入账--支付宝转银行卡 || 银行卡转银行卡
        if (this.data.apiData[key]["n1"]=="24")
            $(".btn-3").eq(0).click();
        else
            $(".btn-3").eq(1).click();
    }
    //客户报表
    else if (key == "GetDepositRecordCommand" || key == "GetBetBonusRecordCommand" || key == "GetPointsRecordCommand" || key == "GetPromotionRecordCommand" || key == "GetWithdrawalRecordCommand" || key == "GetGameTranRecordCommand" || key == "MGSessionRecordCommand" || key == "MGSessionRecordCommand" || key == "GetAnniversaryBonusCommand") {
        if ($("#reportNav li").size() > 0)
            $("#reportNav li.on").click();
    }else if(window.location.href.indexOf("catchFish") > -1){//捕鱼页面
        if (key == "GetAGXINEntry" || this.data.apiData[key].gameId == "12") {
            $(".ag-by-bg").find("a").eq(0).click();
        } else if (key == "GetPTEntry" || this.data.apiData[key].gameId == "15") {
            $(".pt-by-bg").find("a").eq(0).click();
        } else if (key == "GetGGEntry" || this.data.apiData[key].gameId == "20") {
            $(".gg-by-bg").find("a").eq(0).click();
        }
    }
    //进入游戏
    // else if (key=="GetPTEntry"||key == "GetMGINEntry" || key == "GetMGEntry" || key == "GetBSGEntry" || key == "GetTTGEntry" || key == "GetAGXINEntry" || key == "GetDTEntry") {
    //     var data = this.data.apiData;
    //     var gameIdObj = { "GetPTEntry": "15", "GetMGINEntry": "17", "GetMGEntry": "16", "GetBSGEntry": "19", "GetTTGEntry": "18", "GetAGXINEntry": "12", "GetDTEntry": "21" };
    //     var gameCode = data[key]["GameCode"];
    //     var gameId = gameIdObj[key];
    //     var isHtml5 = data[key]["IsHtml5"];
    //     if (key == "GetMGINEntry" && gameCode == "mgLiveGame") return;
    //     if (window.location.href.indexOf("egame") > -1) {
    //         playGame(null, false, gameCode, gameId, isHtml5);
    //     } else {
    //         hot_playGame(null, gameCode, gameId, isHtml5);
    //     }
    // }
    else if (that.data.url && ~that.data.url.indexOf('gameloading.aspx') && !~location.href.indexOf('gameloading.aspx')) {
        return;
    }
    else {
         if (index == "0") {
             setTimeout(function () {
                 location.href = that.data.url;
             }, 700);
            return true;
        }
        if (typeof index === "string") {
            index = parseInt(index);
        }
        if (index === 0) {
            setTimeout(function () {
                location.href = that.data.url;
            }, 700);
        }
        else
            closeDialog(index);
    }
}

/**
 * 根据游戏厅的顺序，获取GameId，回调事件
 * @param  {[type]}   key API名称
 * @param  {Function} fn  回调函数
 * @return {[type]}       [description]
 */
loginTimeout.prototype.doSomeofGame = function (key,fn) {
    var gameIdArr = ['PT', 'MG_IN', 'MG', 'BBIN', 'AG_AGIN', 'AG_AG', 'TTG', 'BSG', 'GG'];
    var gameId = this.data.apiData[key].GameID;
    for (var i = 0; i < gameIdArr.length; i++) {
        if (gameIdArr[i] != gameId) {
            continue;
        }
        (function (index) {
            var _this = this;
            setTimeout(function () {
                if (typeof fn == "function") {
                    fn.call(_this,index);
                }
            }, 100);

        })(i)
    }
}


loginTimeout.prototype.doEventBeforeTimeout = function () {
    this.getCookieData();
    var curDom = this.data.curDom;
    var id = curDom.id;
    var classNames = curDom.className;
    var outerHTML = curDom.outerHTML;
    var parentHTML = curDom.parentHTML;
    if (id) {
        $("#" + id).click();
    }
    else
        if (outerHTML && parentHTML) {
            var $dom = $(outerHTML);
            var $parentDom = $(parentHTML);
            $parentDom.append($dom);
            $("body").append($parentDom);
            $dom.click();
            $dom.remove();
            $parentDom.remove();
        } else {
            var index = this.data.mIndex;
            index = index == undefined ? 0 : index;
            if (index == "0") {
                location.href = this.data.url;
                return true;
            }
            if (typeof index === "string") {
                index = parseInt(index);
            }
            if (index === 0)
                window.location.href = this.data.url;
            else
                closeDialog(index);
        }
    $.removeCookie("loginTimeoutData");
}


/*
    网站loading
*/
function loadingPage(option) {
    var _opt = {
        type:"",
        imgRootPath: "",
        divClass: "",
        callBack: function (obj) { },
        closeBack: function (obj) { }
    };

    _opt = $.extend(_opt, option);

    var loadImgData = {
        load1: "loading-win8.gif",
        load2: "pic/bg/egame-loading.gif",
        load3: "pic/loading/data-loading.gif",
        load4: "pic/bg/egame-loading.gif"
    }

    return {
        loadHtmlObj: "",
        baseLoadObj: "",
        Initquest: function () {
            $(".load1_ref, .load2_ref, .load3_ref").remove();
            var loadClass = $(_opt.divClass);
            baseLoadObj = loadClass;
            var loadHtml;
            if (_opt.type == "load1") {
                loadHtml = $('<div class="loading u-load-div load1_ref"><img src="' + imgRootPath + 'image/' + loadImgData[_opt.type] + '"/></div>')
            } else if (_opt.type == "load2") {
                loadHtml = $('<div style="text-align: center" class="clr load2_ref"><img src="' + imgRootPath + 'image/' + loadImgData[_opt.type] + '"/></div>');
            } else if (_opt.type == "load3") {
                loadHtml = $('<div class="data-loading load3_ref"><img src="' + imgRootPath + 'image/' + loadImgData[_opt.type] + '" width="100"/></div>');
            } else if (_opt.type == "load4") {
                loadHtml = $('<div style="text-align: center" class="clr load2_ref tb-n-uloading"><div><img src="' + imgRootPath + 'image/' + loadImgData[_opt.type] + '"/></div></div>');
            }
            loadClass.append(loadHtml);
            this.loadHtmlObj = loadHtml;

        },
        Show: function () {
            this.Initquest();
        },
        Hide: function (data, setTime, cb) {
            if (!!data) {
                var status = data.Status;
                var blnData = "";
                if (!status) {
                    blnData = data;
                } else {
                    blnData = data.row;
                }
                if (blnData == "") {
                    var NoDataHtml = '<div class="no-data" style="text-align: center;margin: 20px;"><p>没有找到任何记录！</p></div>';
                    baseLoadObj.append(NoDataHtml);
                }
            }

            var s = setTime || 0;

            if (!!cb) {
                setTimeout(cb, s);
            }
            else {
                var self = this;
                setTimeout(function () {
                    if (self.loadHtmlObj)
                        self.loadHtmlObj.remove();
                }, s);
            }

        }
    }

}

/**
* 显示倒计时
* $(selector).countingDown(time, onEnd)
* @param: time . unit: ms
* @param: onEnd, function. will be invoked when time up
*/
$.fn.countingDown = (function () {
    var second = 1000;
    var minute = second * 60;
    var hour = minute * 60;
    var day = hour * 24;
    var bu0 = Util.pad0;
    function defaultFormatter($elem, time) {
        if (time / day > 3) {
            $elem.text(Math.floor(time / day) + '天');
        } else {
            var hours = Math.floor(time / hour);
            var str = bu0(hours) + moment(time).format(':mm:ss');
            // console.log(str);
            $elem.text(str);
        }
    }
    return function (time, onEnd, formatter) {
        if (time <=0 || !time) return;
        return this.each(function (i, elem) {
            var $elem = $(elem);
            clearTimeout(elem.__timer__);
            elem.__timer__ = null;
            formatter = formatter || defaultFormatter;
            // console.log(i, elem);
            function refresh() {
                formatter($elem, time);
                if (time >= second) {
                    // console.log(time);
                    elem.__timer__ = setTimeout(refresh, second);
                } else {
                    // $elem.text('00:00:00');
                    // formatter()
                    return onEnd.call(elem);
                }
                // if (time / day > 3) {
                //     $elem.text(Math.floor(time / day) + '天');
                // } else {
                //     var hours = Math.floor(time / hour);
                //     var str = bu0(hours) + moment(time).format(':mm:ss');
                //     // console.log(str);
                //     $elem.text(str);
                // }
                time -= second;
            }
            refresh();
        })
    }
})();
/**
* 显示倒计时, 可指定格式字符串
* $(selector).countingDown(time, onEnd)
* @param: time . unit: ms
* @param: onEnd, function. will be invoked when time up
* @param: formatter, string, default: ''
*/
$.fn.countingFormat = (function () {
    var second = 1000;
    var minute = second * 60;
    var hour = minute * 60;
    var day = hour * 24;
    var bu0 = Util.pad0;
    function defaultFormatter(time) {
        if (time > day *3) {
            return ['%d 天', {d: Math.floor(time / day)}]
        }
        var md = moment(time);
        return ['%h:%m:%s', {
            h: Math.floor(time % day /hour),
            m: Math.floor( time % hour / minute),
            s: md.seconds()
        }];
    }
    function replace(arr) {
        return arr[0].replace(/\%([dhms])/g, function (m, $1) {
            // console.log(m, $1);
            return arr[1][$1] != void 0 ? bu0(arr[1][$1]) : 'NaN';
        })
    }
    return function (time, onEnd, formatter) {
        if (time <=0 ) return;
        return this.each(function (i, elem) {
            var $elem = $(elem);
            clearTimeout(elem.__timer__);
            elem.__timer__ = null;
            formatter = formatter || defaultFormatter;
            // console.log(i, elem);
            function refresh() {
                clearTimeout(elem.__timer__);
                var fo = formatter(time);
                $elem.html(replace(fo));
                if (time >= second) {
                    // console.log(time);
                    elem.__timer__ = setTimeout(refresh, second);
                } else {
                    // $elem.text('00:00:00');
                    // formatter()
                    return onEnd.call(elem);
                }
                time -= second;
            }
            refresh();
        })
    }
})();

/**
* 获取签到状态
* $(selector).countingDown(time, onEnd)
* @param: time . unit: ms
* @param: onEnd, function. will be invoked when time up
* @param: formatter, string, default: ''
*/
var CheckInState = function() {
    var name = 'CHECKED_IN_TODAY';
    return {
        set: function (signed, serverTime) {
            if (signed != null) {
                var date = new Date(serverTime);
                date.setDate(date.getDate() + 1);
                var newDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                console.log(newDate);
                $.cookie(name, signed, {expires: newDate, path: '/'})
            }
        },
        get: function () {
            return $.cookie(name) == 'true';
        },
        check: function () {
            if (!CheckInState.get()) {
                $.invoke_api({ TengBiMallSigned: {}})
                    .then(function (res) {
                        if (res.Status ===1 && res.row.Signed) {
                            $('.btn_checkin').addClass('signed').text('已签到');
                            CheckInState.set(true, res.serverTime);
                        }
                    })
            }
            else {
                // setTimeout(function () {
                    $('.btn_checkin').addClass('signed').text('已签到');
                // }, 300)

            }

        }
    }
}();